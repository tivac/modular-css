<style type="text/css">
@value buttonLinkCss: "./button-link.css";
@value borderColor: #EEEEEE;

body {
    font-family: 'Roboto', sans-serif;

    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
}

pre,
textarea,
:global(.CodeMirror) {
    font-family: 'Inconsolata', monospace;
}

.repl {
    width: 100%;
    height: 100%;

    display: grid;

    grid: "input output";
}

.input {
    grid-area: "input";

    border-right: 1px solid borderColor;
}

.tabs {
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    align-items: stretch;

    border-bottom: 1px solid borderColor;
}

.add {
    composes: button from buttonLinkCss;

    align-self: center;
}

.tab {
    padding: 5px 25px 5px 5px;

    position: relative;
}

.tab + .tab {
    margin-left: 10px;
}

.tabon {
    composes: tab;

    border-bottom: 1px solid black;
}

.file {
    composes: button from buttonLinkCss;

    text-decoration: none;
    color: #777;
}

.tabon .file {
    color: #444;
}

.remove {
    composes: button from buttonLinkCss;

    position: absolute;

    top: 50%;
    right: 0%;

    width: 20px;

    transform: translateY(-50%);
}

.output {
    grid-area: "output";
}

.error {}

.erroron {}

.result {}

.compositions {}

</style>

<div class="{css.repl}">
    <div class="{css.input}">
        <div class="{css.tabs}">
            <button class="{css.add}" on:click="$add()">➕</button>
            
            {#each [ ...$files.values() ] as file (file)}
                {#if tab === file}
                <div class="{css.tabon}">
                    <button class="{css.file}">{file}</button>
                    <button class="{css.remove}" on:click="$remove(file)">❌</button>
                </div>
                {:else}
                <div class="{css.tab}">
                    <button class="{css.file}" on:click="set({ tab : file })">{file}</button>
                </div>
                {/if}
            {/each}
        </div>

        <Editor file={tab} error={$error.file === tab ? $error : false} />
    </div>

    <div class="{css.output}">
        <div class="{error ? css.erroron : css.error}">
            {error ? error.toString() : ""}
        </div>

        <div class="{css.result}">
        {#await loading}
            <div class="loading">Loading editor...</div>
        {:then _}
            <div class="output">
                <textarea ref:output></textarea>
            </div>
        {:catch err}
            <div class="loaderror">Unable to load editor</div>
        {/await}
        </div>

        <div class="{css.compositions}">
            <!-- This is silly, need a better story here... -->
            <!--
            {#each Object.entries($compositions).reverse() as [ file, props ] (file)}
            <h4>{file}</h4>
            <dl>
                {#each Object.entries(props) as [ key, value ]}
                <dt>.{key}</dt>
                <dd>"{value}"</dd>
                {/each}
            </dl>
            {:else}
            No data yet
            {/each}
            -->
        </div>
    </div>
</div>

<script>
import store from "./store.js";

export default {
    components : {
        Editor : "./editor.html",
    },

    store : () => store,

    data : () => {
        const { files } = store.get();

        return {
            loading : import("./codemirror.js"),

            // iterators are so much fun
            tab : files.values().next().value,
        };
    },

    oncreate() {
        const { loading } = this.get();

        // Instantiate codemirror once it's loaded
        loading.then((mod) => {
            const { codemirror, theme } = mod;

            this.cm = codemirror.fromTextArea(this.refs.output, {
                lineNumbers : true,
                lineWrapping : true,
                indentUnit : 4,
                readOnly : true,
                mode : "text/css",
                theme,
            });

            const { css } = this.store.get();

            this.cm.setValue(css);
        });
    },

    onstate({ changed, current }) {
        console.log(changed, current);

        if(changed.$css && this.cm) {
            const { $css } = current;

            this.cm.setValue($css);
        }

        const { tab } = this.get();
        const { $files } = current;

        if(changed.$files && !$files.has(tab)) {
            this.set({
                // iterators are so much fun
                tab : $files.values().next().value,
            });
        }
    },
};
</script>
