<link rel="stylesheet" href="./app.css" />

{#if error}
<div>
    <code><pre>{error.toString()}</pre></code>
</div>
{/if}

<div>
    <button on:click="$add()">➕</button>
</div>

{#each [ ...$files.values() ] as file (file)}
    <h2>{file} <button on:click="$remove(file)">♻</button></h2>

    <Editor {file} error="{$error.file === file ? $error : false}" />
{/each}

<div>
    <h2>CSS Output</h2>
    {#await loading}
        <div class="loading">Loading editor...</div>
    {:then _}
        <div class="output">
            <textarea ref:output></textarea>
        </div>
    {:catch err}
        <div class="loaderror">Unable to load editor</div>
    {/await}
</div>

<div>
    <h2>Compositions</h2>
    <!-- This is silly, need a better story here... -->
    {#each Object.entries($compositions).reverse() as [ file, props ] (file)}
    <h4>{file}</h4>
    <dl>
        {#each Object.entries(props) as [ key, value ]}
        <dt>.{key}</dt>
        <dd>"{value}"</dd>
        {/each}
    </dl>
    {:else}
    No data yet
    {/each}
</div>

<script>
import store from "./store.js";

export default {
    components : {
        Editor : "./editor.html",
    },

    store : () => store,

    data : () => ({
        loading : import("./codemirror.js"),
    }),

    oncreate() {
        const { loading } = this.get();

        // Instantiate codemirror once it's loaded
        loading.then((mod) => {
            const { codemirror, theme } = mod;

            this.cm = codemirror.fromTextArea(this.refs.output, {
                lineNumbers : true,
                lineWrapping : true,
                indentUnit : 4,
                readOnly : true,
                mode : "text/css",
                theme,
            });

            const { css } = this.store.get();

            this.cm.setValue(css);
        });

        this.store.on("state", ({ changed, current }) => {
            if(!changed.css || !this.cm) {
                return;
            }

            const { css } = current;

            this.cm.setValue(css);
        });
    },
};
</script>
