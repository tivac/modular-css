<link rel="stylesheet" href="./editor.css" />

{#await loading}
    <div class="loading">Loading editor...</div>
{:then _}
    <div class="editor">
        <textarea ref:textarea></textarea>
    </div>
{:catch err}
    <div class="loaderror">Unable to load editor</div>
{/await}

<script>
import fs from "fs";

export default {
    data : () => ({
        content : "",

        file : false,
        error : false,

        loading : import("./codemirror.js").then((m) => m.default),
    }),

    methods : {
        oninput(content) {
            const { file } = this.get();

            fs.writeFileSync(file, content, "utf8");

            this.set({
                content,
            });
        },
    },

    // Read file contents on creation
    oncreate() {
        const { file, loading } = this.get();

        let content;

        try {
            content = fs.readFileSync(file, "utf8");
            
            console.log(file, content);

            this.set({ content });
        } catch(e) {
            // NO-OP
        }

        // Instantiate codemirror once it's loaded
        loading.then((codemirror) => {
            // TODO: why isn't this updating w/ content?
            this.cm = codemirror.fromTextArea(this.refs.textarea, {
                lineNumbers : true,
                lineWrapping : true,
                indentUnit : 4,
                value : content,
                theme : "mdn-like",
                mode : "text/css",
            });

            console.log(content, this.cm.getValue());

            this.cm.on("change", () =>
                this.set({
                    content : this.cm.getValue()
                })
            );
        });
    },

    onstate({ changed, current, previous }) {
        if(!previous) {
            return;
        }

        if(changed.content) {
            console.log("content changed", current);

            const { file, content } = current;

            fs.writeFileSync(file, content, "utf8");

            this.fire("input");
        }

        if(changed.error) {
            const { error : prev } = previous;
            const { error : curr } = current;
            
            if(this.clearError) {
                this.clearError();
            }

            if(!curr) {
                return;
            }

            const { line, column, source } = curr;
            
            // Mark the offending line
            this.cm.addLineClass(line - 1, "wrap", css.errorLine);

            // And underline the offending text as best we can
            const marker = this.cm.markText(
                { line : line - 1, ch : column - 1 },
                { line : line - 1, ch : column - 1 + source.trimEnd().length },
                { className : css.errorLocation }
            );

            // Save a function to clear all the error markers
            this.clearError = () => {
                this.cm.removeLineClass(line - 1, "wrap", css.errorLine);

                marker.clear();
            };
        }
    },

    ondestroy() {
        const { file } = this.get();

        // Delete the file on editor destruction
        fs.unlinkSync(file);

        // And blow up the code mirror instance for good measure
        this.cm.toTextArea();
    },
};
</script>
