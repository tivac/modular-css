<link rel="stylesheet" href="./editor.css" />

{#await loading}
    <div class="loading">Loading editor...</div>
{:then _}
    <div class="editor">
        <textarea ref:textarea></textarea>
    </div>
{:catch err}
    <div class="loaderror">Unable to load editor</div>
{/await}

<script>
import fs from "fs";

import store from "./store.js";
import listen from "./listen.js";

export default {
    store : () => store,

    data : () => ({
        file  : false,
        error : false,

        loading : import("./codemirror.js"),
    }),

    // Read file contents on creation
    oncreate() {
        const { file, loading } = this.get();

        let content;

        try {
            content = fs.readFileSync(file, "utf8");
        } catch(e) {
            content = "";
        }
        
        // Instantiate codemirror once it's loaded
        loading.then((mod) => {
            const { codemirror, theme } = mod;

            this.cm = codemirror.fromTextArea(this.refs.textarea, {
                lineNumbers : true,
                lineWrapping : true,
                indentUnit : 4,
                mode : "text/css",
                theme,
            });

            // .fromTextArea defaults to using <texarea>.value, so need
            // to call this immediately afterwards to get content into it
            this.cm.setValue(content);

            this.cm.on("change", () => {
                const { file } = this.get();

                this.store.update(file, this.cm.getValue())
            });

            // Update editor contents when new file target is passed in
            listen(this, "file", ({ file}) => {
                this.cm.setValue(fs.readFileSync(file, "utf8"));
            });

            listen(this.store, "error", ({ error : curr }, { error : prev }) => {
                console.log("store error", curr, prev);
                
                if(this.clearError) {
                    this.clearError();
                }

                if(!curr) {
                    return;
                }

                const { line, column, source } = curr;
                
                // Mark the offending line
                this.cm.addLineClass(line - 1, "wrap", css.errorLine);

                // And underline the offending text as best we can
                const marker = this.cm.markText(
                    { line : line - 1, ch : column - 1 },
                    { line : line - 1, ch : column - 1 + source.trimEnd().length },
                    { className : css.errorLocation }
                );

                // Save a function to clear all the error markers
                this.clearError = () => {
                    this.cm.removeLineClass(line - 1, "wrap", css.errorLine);

                    marker.clear();
                };
            });
        });
    },
    
    ondestroy() {
        // Blow up the code mirror instance
        this.cm.toTextArea();

        this.cm = null;
    },
};
</script>
