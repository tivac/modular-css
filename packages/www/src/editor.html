<style>
.errorLocation {
    position: relative;
    border-bottom: 2px solid rgb(200, 0, 0);
}

.errorLine {
    background-color: rgba(200, 0, 0, 0.05);
}
</style>

<CodeMirror bind:output=content ref:codemirror/>

<script>
import fs from "fs";

import store from "./store.js";
import listen from "./listen.js";

export default {
    components : {
        CodeMirror : "./codemirror.html",
    },

    store : () => store,

    data : () => ({
        content : "",
    }),

    // Read file contents on creation
    oncreate() {
        listen(this.store, "file", ({ file }) => {
            let input;

            try {
                input = fs.readFileSync(file, "utf8");
            } catch(e) {
                input = "";
            }

            this.refs.codemirror.set({ input });
        });
        
        listen(this, "content", ({ content }) => {
            const { file } = this.store.get();

            this.store.update(file, content);
        });
        
        // Mark text in the editor when an error occurs
        listen(this.store, "error", ({ error : curr }, { error : prev }) => {
            if(this.clearError) {
                this.clearError();
            }
            
            const { file } = this.get();
            const { codemirror } = this.refs.codemirror.get();

            if(!curr || curr.file !== file || !codemirror) {
                return;
            }

            const { line, column, source } = curr;
            
            // Mark the offending line
            codemirror.addLineClass(line - 1, "wrap", css.errorLine);

            // And underline the offending text as best we can
            const marker = codemirror.markText(
                { line : line - 1, ch : column - 1 },
                { line : line - 1, ch : column - 1 + source.trimEnd().length },
                { className : css.errorLocation }
            );

            // Save a function to clear all the error markers
            this.clearError = () => {
                codemirror.removeLineClass(line - 1, "wrap", css.errorLine);

                marker.clear();
            };
        });
    },
};
</script>
